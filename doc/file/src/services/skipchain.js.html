<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/services/skipchain.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-App">App</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">app</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/app/home.js~Home.html">Home</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/html-iframe</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/html-iframe/html-iframe.js~HTMLIFrame.html">HTMLIFrame</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/loading</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/loading/loading-spinner.js~LoadingSpinner.html">LoadingSpinner</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/module.js~Module.html">Module</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/html</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/html/module-html.js~ModuleHTML.html">ModuleHTML</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/random</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/random/module-random.js~ModuleRandom.html">ModuleRandom</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/signature</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/signature/module-sign.js~ModuleSign.html">ModuleSign</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/signature/module-verify.js~ModuleVerify.html">ModuleVerify</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/signature/utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/signature/utils/drop-file-area.js~DropFileArea.html">DropFileArea</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/signature/utils/sign-area.js~SignArea.html">SignArea</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/skipchain</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/skipchain/module-skipchain.js~ModuleSkipChain.html">ModuleSkipChain</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/servers-status</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/servers-status/last-update.js~LastUpdate.html">LastUpdate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/servers-status/servers-status.js~ServersStatus.html">ServersStatus</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/cothority-messages.js~CothorityMessages.html">CothorityMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/cothority-messages.js~CothorityProtobuf.html">CothorityProtobuf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-index">index</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/signature-file.js~SignatureFile.html">SignatureFile</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/genesis.js~GenesisService.html">GenesisService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/iframe.js~IFrameService.html">IFrameService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/skipchain.js~SkipChainService.html">SkipChainService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/status.js~StatusService.html">StatusService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/websocket.js~CothorityWebsocket.html">CothorityWebsocket</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buf2hex">buf2hex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hex2buf">hex2buf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hashFile">hashFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readAsString">readAsString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-tcp2ws">tcp2ws</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/services/skipchain.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import CothorityWS from &apos;./websocket&apos;
import {buf2hex} from &apos;../utils/buffer&apos;

/**
 * This service provide the function to get the list of blocks of the skipchain with the
 * underlying logic and verification
 *
 * @author Gaylor Bosson (gaylor.bosson@epfl.ch)
 */
export class SkipChainService {

  /**
   * Given a list of servers and a genesis block id, try to get the latest block and return a promise that will resolve
   * with the list of server&apos;s addresses (WebSocket address)
   * @param {Array} servers
   * @param {String} genesisID
   * @returns {Promise}
   */
  getLatestBlock(servers, genesisID) {
    let index = 0;

    return new Promise((resolve, reject) =&gt; {
      if (!servers || !genesisID || servers.length === 0) {
        reject(new Error(&quot;Cannot get the latest updates of the skip-chain.&quot;));
      }

      const onSuccess = (blocks) =&gt; {
        resolve(blocks);
      };

      const onError = () =&gt; {
        // Try the next server
        index++;

        if (index &lt; servers.length) {
          this._getUpdates(servers[index], genesisID).then(onSuccess, onError);
        }
        else {
          reject(new Error(&quot;No servers available&quot;));
        }
      };

      this._getUpdates(servers[index], genesisID).then(onSuccess, onError);
    });
  }

  /**
   * Try to get the update list of skipblocks from an address and a genesis block id
   * Parse the response to resolve the promise with the list of WebSocket addresses of the servers
   * @param {String} address - ws address to try
   * @param {String} genesisID - Hex representation of the genesis block id
   * @returns {Promise.&lt;Array&gt;|*}
   * @private
   */
  _getUpdates(address, genesisID) {

    return CothorityWS.getLatestBlock(address, genesisID).then(

      (response) =&gt; {
        if (!response.Update) {
          throw new Error(&quot;Malformed response&quot;);
        }

        if (!this._verifyUpdates(response.Update)) {
          throw new Error(&quot;Update blocks are corrupted&quot;);
        }

        return response.Update;
      }

    );

  }

  /**
   * Check the sanity of the skip blocks and return false if an error occurred
   * @param {Array} blocks
   * @returns {boolean}
   * @private
   */
  _verifyUpdates(blocks) {
    return blocks.every((block, blockIndex) =&gt; {

      const hash = cryptoJS.hashSkipBlock(block); // eslint-disable-line

      // Check the hash of the block
      if (buf2hex(hash) !== buf2hex(block.Hash)) {
        console.log(&quot;Wrong hash for block&quot;, blockIndex, block);
        return false;
      }

      block._hash_verified = true;

      // Check the forward links
      const publicKeys = block.Roster.list.map(server =&gt; server.public);
      let isSignatureVerified = true;

      block.ForwardLink.forEach(link =&gt; {
        const res = cryptoJS.verifyForwardLink({ // eslint-disable-line
          publicKeys: publicKeys,
          hash: link.Hash,
          signature: link.Signature
        });
        if (!res) {
          console.log(&quot;Wrong signature for block&quot;, blockIndex, block);
          isSignatureVerified = false;
        }
      });

      block._signature_verified = isSignatureVerified;
      if (!isSignatureVerified) {
        return false;
      }

      if (blockIndex &gt; 0) { // Genesis back link is random
        for (let i = 0; i &lt; block.BackLinkIDs.length; i++) {
          const link = buf2hex(block.BackLinkIDs[i]);

          const prev = blocks.filter(b =&gt; buf2hex(b.Hash) === link &amp;&amp; block !== b).pop();
          if (prev &amp;&amp; (!prev._signature_verified || !prev._backlink_verified)) {
            console.log(&quot;Back link is corrupted&quot;);
            return false;
          }
        }
      }

      block._backlink_verified = true;

      return true;
    });

  }

}

export default new SkipChainService();</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
