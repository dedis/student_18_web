<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/services/genesis.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-App">App</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">app</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/app/home.js~Home.html">Home</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/html-iframe</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/html-iframe/html-iframe.js~HTMLIFrame.html">HTMLIFrame</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/loading</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/loading/loading-spinner.js~LoadingSpinner.html">LoadingSpinner</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/module.js~Module.html">Module</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/html</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/html/module-html.js~ModuleHTML.html">ModuleHTML</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/random</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/random/module-random.js~ModuleRandom.html">ModuleRandom</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/signature</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/signature/module-sign.js~ModuleSign.html">ModuleSign</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/signature/module-verify.js~ModuleVerify.html">ModuleVerify</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/signature/utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/signature/utils/drop-file-area.js~DropFileArea.html">DropFileArea</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/signature/utils/sign-area.js~SignArea.html">SignArea</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/module/skipchain</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/module/skipchain/module-skipchain.js~ModuleSkipChain.html">ModuleSkipChain</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/servers-status</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/servers-status/last-update.js~LastUpdate.html">LastUpdate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/servers-status/servers-status.js~ServersStatus.html">ServersStatus</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/cothority-messages.js~CothorityMessages.html">CothorityMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/cothority-messages.js~CothorityProtobuf.html">CothorityProtobuf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-index">index</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/signature-file.js~SignatureFile.html">SignatureFile</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/genesis.js~GenesisService.html">GenesisService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/iframe.js~IFrameService.html">IFrameService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/skipchain.js~SkipChainService.html">SkipChainService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/status.js~StatusService.html">StatusService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/websocket.js~CothorityWebsocket.html">CothorityWebsocket</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buf2hex">buf2hex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hex2buf">hex2buf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hashFile">hashFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readAsString">readAsString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-tcp2ws">tcp2ws</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/services/genesis.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import &apos;whatwg-fetch&apos;

import SkipChainService from &apos;./skipchain&apos;
import {hex2buf, buf2hex} from &apos;../utils/buffer&apos;
import {tcp2ws} from &apos;../utils/network&apos;

const GENESIS_BLOCK_SERVER = &quot;https://skipchain.dedis.ch/&quot;;

/**
 * This service will contact the DEDIS server to get the list of skipchains with their servers. Those servers may
 * not be available.
 *
 * @author Gaylor Bosson (gaylor.bosson@epfl.ch)
 */
export class GenesisService {

  /**
   * Make a request to the GENESIS_BLOCK_SERVER url to get the list of genesis IDs of the skipchains
   * @constructor
   */
  constructor() {
    this.listeners = [];
    this.genesisList = [];
    this.curr_genesis = &apos;&apos;; // hex form
    this.blocks = [];

    // Get the servers list and the genesis block id
    this._fetch_request = fetch(GENESIS_BLOCK_SERVER, {headers: {&apos;Content-Type&apos;: &apos;application/json&apos;}})
      .then(
        (response) =&gt; response.json().then(data =&gt; {
          // We keep the list of available blocks
          this.genesisList = data.Blocks;
          this.curr_genesis = this.genesisList[0].GenesisID;

          this._request = this._fetchStatusForGenesisID(this.curr_genesis);
        })
      )
      .catch(() =&gt; {
        this.updateGenesis(new Error(&quot;Failed to get the list of Genesis blocks.&quot;));
      });
  }

  /**
   * Add the given listener to the list of object which will be called on update events
   * @param {Object} listener must have onGenesisUpdate function to get the updates
   */
  subscribe(listener) {
    if (this.listeners.indexOf(listener &lt; 0)) {
      this.listeners.push(listener);

      // Trigger an event after the subscription. It can be an error update if one occurred before
      if (this.error) {
        this._triggerError(listener);
      }
      else {
        this._triggerEvent(listener);
      }
    }
  }

  /**
   * Remove the given listener from the list
   * @param {Object} listener
   */
  unsubscribe(listener) {
    const index = this.listeners.indexOf(listener);
    if (index &gt;= 0) {
      this.listeners.splice(index, 1);
    }
  }

  /**
   * Trigger either an update or an error update
   * @param {Error} error a potential error that triggered
   */
  updateGenesis(error) {
    if (error) {
      this.error = error;
      this.listeners.forEach(listener =&gt; this._triggerError(listener));
    }
    else {
      this.listeners.forEach(listener =&gt; this._triggerEvent(listener));
    }
  }

  /**
   * Change the current skipchain given the ID of the genesis block
   * @param {String} id hex form of the ID
   */
  setCurrentGenesisID(id) {
    const block = this.genesisList.filter(b =&gt; b.GenesisID === id).pop();
    if (block) {
      // if the id exists we fetch the skipchain
      this.curr_genesis = id;
      this._request = this._fetchStatusForGenesisID(id);
    }
  }

  /**
   * Given a genesis ID and a block ID, it will get the servers of the skipchain and then fetch the list of
   * blocks of the skipchain to finally return the block if it exists
   * If the block ID is not provided, we return the latest block
   * @param {String} id - Genesis ID
   * @param {String} blockID - 64 hex-digits Block ID
   * @returns {Promise}
   */
  getLatestFromGenesisID(id, blockID = null) {
    return new Promise((resolve, reject) =&gt; {
      fetch(GENESIS_BLOCK_SERVER + id + &apos;.html&apos;, {headers: {&apos;Content-Type&apos;: &apos;application/json&apos;}})
        .then(
          (response) =&gt; response.json().then(data =&gt; {
            SkipChainService.getLatestBlock(data.Servers.map(addr =&gt; tcp2ws(addr)), hex2buf(id))
              .then(data =&gt; {
                if (blockID) {
                  const block = data.filter(block =&gt; buf2hex(block.Hash) === blockID).pop();
                  block ? resolve(block) : reject();
                }
                else {
                  resolve(data.pop());
                }
              })
              .catch(e =&gt; reject(e));
          })
        )
        .catch(e =&gt; reject(e));
    });
  }

  /**
   * Trigger an update event to the listener with params:
   *  1. blocks The list of blocks of the skipchain
   *  2. genesisList The current list of available skipchains
   *  3. curr_genesis The current genesis ID of the current skipchain
   * @param {object} listener - An object with a declaration of onGenesisUpdate
   * @private
   */
  _triggerEvent(listener) {
    if (typeof listener.onGenesisUpdate === &apos;function&apos;) {
      listener.onGenesisUpdate(this.blocks, this.genesisList, this.curr_genesis);
    }
  }

  /**
   * Trigger an error event
   * @param {Object} listener
   * @private
   */
  _triggerError(listener) {
    if (typeof listener.onGenesisError === &apos;function&apos;) {
      listener.onGenesisError(this.error);
    }
  }

  /**
   * It will check that the skipchain exists and then it gets the list of blocks. Finally
   * it trigger according to the result either an update or an error
   * @param {String} id - The genesis ID
   * @private
   */
  _fetchStatusForGenesisID(id) {
    const block = this.genesisList.filter(b =&gt; b.GenesisID === id).pop();
    if (!block) {
      return this.updateGenesis(new Error(&quot;Cannot find the block associated with the genesis ID&quot;));
    }

    const servers = block.Servers.map(addr =&gt; tcp2ws(addr));

    return SkipChainService.getLatestBlock(servers, hex2buf(block.GenesisID))
      .then((data) =&gt; {
        this.blocks = data;
        this.updateGenesis(null);
      })
      .catch((e) =&gt; this.updateGenesis(e));
  }

}

export default new GenesisService()</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
